<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #e50914;
            --secondary-color: #221f1f;
            --background-color: #141414;
            --text-color: #ffffff;
            --card-color: #333333;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar styles */
        .sidebar {
            width: 250px;
            background-color: var(--secondary-color);
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #444;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #aaa;
            padding: 10px 20px;
            margin-top: 15px;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            background-color: var(--primary-color);
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main content styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
        }

        .date {
            color: #aaa;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .card-icon.primary {
            background-color: var(--primary-color);
        }

        .card-icon.success {
            background-color: var(--success-color);
        }

        .card-icon.warning {
            background-color: var(--warning-color);
        }

        .card-icon.info {
            background-color: var(--info-color);
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            margin: 15px 0;
        }

        .card-description {
            color: #aaa;
            font-size: 14px;
        }

        /* Iframe for loading microservice pages */
        #microservice-content {
            width: 100%;
            height: calc(100vh - 130px);
            border: none;
            border-radius: 8px;
            background-color: var(--card-color);
            display: none;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: visible;
            }

            .logo, .menu-title, .menu-item span {
                display: none;
            }

            .sidebar-header {
                padding: 20px 0;
                text-align: center;
            }

            .menu-item {
                padding: 15px 0;
                justify-content: center;
            }

            .menu-item i {
                margin-right: 0;
                font-size: 18px;
            }

            .main-content {
                margin-left: 70px;
                width: calc(100% - 70px);
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">CineMatch</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-title">Dashboard</div>
            <a href="/" class="menu-item active" id="dashboard-link">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            
            <div class="menu-title">Content Management</div>
            <a href="/admin/movies" class="menu-item" id="movies-link">
                <i class="fas fa-film"></i>
                <span>Movies</span>
            </a>
            <a href="/admin/theaters" class="menu-item" id="theaters-link">
                <i class="fas fa-building"></i>
                <span>Theaters</span>
            </a>
            <a href="/admin/schedules" class="menu-item" id="schedules-link">
                <i class="fas fa-calendar-alt"></i>
                <span>Schedules</span>
            </a>
            
            <div class="menu-title">User Management</div>
            <a href="/admin/users" class="menu-item" id="users-link">
                <i class="fas fa-users"></i>
                <span>Users</span>
            </a>
            <a href="/admin/bookings" class="menu-item" id="bookings-link">
                <i class="fas fa-ticket-alt"></i>
                <span>Bookings</span>
            </a>
            
            <div class="menu-title">Business Intelligence</div>
            <a href="/admin/recommendations" class="menu-item" id="recommendations-link">
                <i class="fas fa-lightbulb"></i>
                <span>Recommendations</span>
            </a>
            <a href="/admin/payments" class="menu-item" id="payments-link">
                <i class="fas fa-credit-card"></i>
                <span>Payments</span>
            </a>
            <a href="/admin/notifications" class="menu-item" id="notifications-link">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </a>
            
            <div class="menu-title">System</div>
            <a href="/admin/health" class="menu-item" id="health-link">
                <i class="fas fa-heartbeat"></i>
                <span>System Health</span>
            </a>
            <a href="/user" class="menu-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Go to User View</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="dashboard-content">
        <div class="page-header">
            <h1 class="page-title">Admin Dashboard</h1>
            <div class="date">Today: <span id="current-date"></span></div>
        </div>

        <div class="cards-container">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Total Movies</div>
                    <div class="card-icon primary"><i class="fas fa-film"></i></div>
                </div>
                <div class="card-value" id="total-movies">--</div>
                <div class="card-description">Active movies in the system</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Theater Locations</div>
                    <div class="card-icon success"><i class="fas fa-building"></i></div>
                </div>
                <div class="card-value" id="total-theaters">--</div>
                <div class="card-description">Active theaters across locations</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Registered Users</div>
                    <div class="card-icon info"><i class="fas fa-user"></i></div>
                </div>
                <div class="card-value" id="total-users">--</div>
                <div class="card-description">Total registered users</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Today's Bookings</div>
                    <div class="card-icon warning"><i class="fas fa-ticket-alt"></i></div>
                </div>
                <div class="card-value" id="today-bookings">--</div>
                <div class="card-description">Tickets booked today</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Revenue</div>
                    <div class="card-icon info"><i class="fas fa-money-bill-wave"></i></div>
                </div>
                <div class="card-value" id="today-revenue">--</div>
                <div class="card-description">Total revenue today</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">System Health</div>
                <div class="card-icon primary"><i class="fas fa-heartbeat"></i></div>
            </div>
            <div id="services-health" style="margin-top: 15px;">
                Loading services status...
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
    
            // Fetch dashboard statistics
            fetchDashboardStats();
            
            // Fetch health status
            fetchHealthStatus();
            
            // Set up navigation handlers
            setupNavigation();
        });
    
        // Function to set up navigation between services
        function setupNavigation() {
            const dashboardContent = document.getElementById('dashboard-content');
            
            // Create iframe if it doesn't exist
            let iframe = document.getElementById('microservice-content');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'microservice-content';
                iframe.style.width = '100%';
                iframe.style.height = 'calc(100vh - 130px)';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '8px';
                iframe.style.backgroundColor = 'var(--card-color)';
                document.querySelector('.main-content').appendChild(iframe);
            }
            
            // Map of service links to their respective microservice endpoints
            const serviceEndpoints = {
                'movies-link': 'http://localhost:3002/movies', // movie-service
                'theaters-link': 'http://localhost:3003/theaters', // theater-service
                'schedules-link': 'http://localhost:3000/schedules', // schedule-service
                'users-link': 'http://localhost:3001/users', // user-service
                'bookings-link': 'http://localhost:3004/booking', // booking-service
                'recommendations-link': 'http://localhost:3007/recommendations', // recommendation-service
                'payments-link': 'http://localhost:3005/payments', // payment-service
                'notifications-link': 'http://localhost:3006/notifications', // notification-service
                'health-link': '/health', 
                'dashboard-link': null 
            };

            // Add click handlers to all menu items
            document.querySelectorAll('.menu-item').forEach(menuItem => {
                menuItem.addEventListener('click', function(e) {
                    // Only prevent default for service links (not for "Go to User View")
                    if (this.id && serviceEndpoints.hasOwnProperty(this.id)) {
                        e.preventDefault();
                        
                        // Remove active class from all menu items
                        document.querySelectorAll('.menu-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Add active class to clicked item
                        this.classList.add('active');
                        
                        // Handle dashboard view
                        if (this.id === 'dashboard-link') {
                            dashboardContent.style.display = 'block';
                            iframe.style.display = 'none';
                            return;
                        }
                        
                        // For other services, load in iframe
                        const endpoint = serviceEndpoints[this.id];
                        if (endpoint) {
                            dashboardContent.style.display = 'none';
                            iframe.style.display = 'block';
                            iframe.src = endpoint;
                        }
                    }
                });
            });
        }
    
        // Function to fetch dashboard statistics
        function fetchDashboardStats() {
            // Using a more robust fetch approach with error handling and timeouts
            const fetchWithTimeout = (url, options = {}, timeout = 5000) => {
                return Promise.race([
                    fetch(url, {
                        ...options,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        mode: 'cors'
                    }),
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Request timeout')), timeout)
                    )
                ]);
            };
        
            // Fetch total movies from movie-service
            fetchWithTimeout('http://localhost:3002/movies')
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        console.log('Movies data received:', data); // Add this to debug the response
                        
                        let movieCount = 0;
                        
                        // Handle different possible response formats
                        if (Array.isArray(data)) {
                            // If response is an array of movies
                            movieCount = data.length;
                        } else if (typeof data === 'object') {
                            // If response is an object with count or total property
                            if (data.count !== undefined) {
                                movieCount = data.count;
                            } else if (data.total !== undefined) {
                                movieCount = data.total;
                            } else if (data.movies && Array.isArray(data.movies)) {
                                // If movies are in a nested property
                                movieCount = data.movies.length;
                            }
                        }
                        
                        document.getElementById('total-movies').textContent = movieCount;
                    })
                    .catch(error => {
                        console.error('Error fetching movies:', error);
                        document.getElementById('total-movies').textContent = '0';
                    });
        
            // Fetch total theaters from theater-service
            fetchWithTimeout('http://localhost:3003/theaters')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('total-theaters').textContent = Array.isArray(data) ? data.length : 
                        (data.count || data.total || 0);
                })
                .catch(error => {
                    console.error('Error fetching theaters:', error);
                    document.getElementById('total-theaters').textContent = '0';
                });
        
            // Fetch total users from user-service
            fetchWithTimeout('http://localhost:3001/users')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('total-users').textContent = Array.isArray(data) ? data.length : 
                        (data.count || data.total || 0);
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    document.getElementById('total-users').textContent = '0';
                });
        
            // Fetch today's bookings from booking-service
            fetchWithTimeout('http://localhost:3004/booking/today')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('today-bookings').textContent = data.count || 0;
                })
                .catch(error => {
                    console.error('Error fetching bookings:', error);
                    document.getElementById('today-bookings').textContent = '0';
                });
        
            // Fetch today's revenue from payment-service
            fetchWithTimeout('http://localhost:3005/payments/today')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('today-revenue').textContent = 'Rp ' + 
                        (data.total ? (data.total / 1000000).toFixed(1) + 'M' : '0');
                })
                .catch(error => {
                    console.error('Error fetching revenue:', error);
                    document.getElementById('today-revenue').textContent = 'Rp 0';
                });
        }
        
        // Function to set up navigation between services
        function setupNavigation() {
            const dashboardContent = document.getElementById('dashboard-content');
            
            // Create iframe if it doesn't exist
            let iframe = document.getElementById('microservice-content');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'microservice-content';
                iframe.style.width = '100%';
                iframe.style.height = 'calc(100vh - 130px)';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '8px';
                iframe.style.backgroundColor = 'var(--card-color)';
                document.querySelector('.main-content').appendChild(iframe);
            }
            
            // Map of service links to their respective microservice endpoints
            const serviceEndpoints = {
                'movies-link': 'http://localhost:3002/movies',
                'theaters-link': 'http://localhost:3003/theaters',
                'schedules-link': 'http://localhost:3000/schedules',
                'users-link': 'http://localhost:3001/users',
                'bookings-link': 'http://localhost:3004/booking',
                'recommendations-link': 'http://localhost:3007/recommendations',
                'payments-link': 'http://localhost:3005/payments',
                'notifications-link': 'http://localhost:3006/notifications',
                'health-link': '#health-section', // This will be handled internally, not an iframe
                'dashboard-link': null 
            };
        
            // Add click handlers to all menu items
            document.querySelectorAll('.menu-item').forEach(menuItem => {
                menuItem.addEventListener('click', function(e) {
                    // Only prevent default for service links (not for "Go to User View")
                    if (this.id && serviceEndpoints.hasOwnProperty(this.id)) {
                        e.preventDefault();
                        
                        // Remove active class from all menu items
                        document.querySelectorAll('.menu-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Add active class to clicked item
                        this.classList.add('active');
                        
                        // Handle dashboard view
                        if (this.id === 'dashboard-link') {
                            dashboardContent.style.display = 'block';
                            iframe.style.display = 'none';
                            return;
                        }
                        
                        // Handle health view internally
                        if (this.id === 'health-link') {
                            dashboardContent.style.display = 'none';
                            iframe.style.display = 'none';
                            
                            // Create health section if it doesn't exist
                            let healthSection = document.getElementById('health-section');
                            if (!healthSection) {
                                healthSection = document.createElement('div');
                                healthSection.id = 'health-section';
                                healthSection.className = 'main-content';
                                healthSection.innerHTML = `
                                    <div class="page-header">
                                        <h1 class="page-title">System Health</h1>
                                        <div class="date">Today: <span id="health-date"></span></div>
                                    </div>
                                    <div class="card">
                                        <div class="card-header">
                                            <div class="card-title">Microservices Status</div>
                                            <div class="card-icon primary"><i class="fas fa-heartbeat"></i></div>
                                        </div>
                                        <div id="services-health-detail" style="margin-top: 15px;">
                                            Loading services status...
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(healthSection);
                                
                                // Set current date
                                const now = new Date();
                                document.getElementById('health-date').textContent = now.toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                });
                                
                                // Fetch and display health status
                                fetchDetailedHealthStatus();
                            }
                            
                            healthSection.style.display = 'block';
                            return;
                        }
                        
                        // For other services, load in iframe
                        const endpoint = serviceEndpoints[this.id];
                        if (endpoint) {
                            dashboardContent.style.display = 'none';
                            
                            // Hide health section if it exists
                            const healthSection = document.getElementById('health-section');
                            if (healthSection) {
                                healthSection.style.display = 'none';
                            }
                            
                            iframe.style.display = 'block';
                            iframe.src = endpoint;
                        }
                    }
                });
            });
        }
        
        // Function to fetch health status from all microservices
        function fetchHealthStatus() {
            // Define all services to check
            const services = [
                { name: 'Movie Service', url: 'http://localhost:3002/health' },
                { name: 'Theater Service', url: 'http://localhost:3003/health' },
                { name: 'Schedule Service', url: 'http://localhost:3000/health' },
                { name: 'User Service', url: 'http://localhost:3001/health' },
                { name: 'Booking Service', url: 'http://localhost:3004/health' },
                { name: 'Recommendation Service', url: 'http://localhost:3007/health' },
                { name: 'Payment Service', url: 'http://localhost:3005/health' },
                { name: 'Notification Service', url: 'http://localhost:3006/health' }
            ];
            
            const servicesHealth = document.getElementById('services-health');
            servicesHealth.innerHTML = '<p>Checking service health...</p>';
            
            // More robust health check with fallback for services that might be down
            Promise.all(
                services.map(service => {
                    return fetch(service.url, { 
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors',
                        // Add shorter timeout to prevent long waits
                        signal: AbortSignal.timeout(2000)
                    })
                    .then(response => {
                        if (response.ok) {
                            return { name: service.name, status: 'UP' };
                        } else {
                            return { name: service.name, status: 'DOWN' };
                        }
                    })
                    .catch(() => {
                        return { name: service.name, status: 'DOWN' };
                    });
                })
            )
            .then(results => {
                const servicesUp = results.filter(result => result.status === 'UP').length;
                const totalServices = services.length;
                
                // Simple summary for dashboard view
                servicesHealth.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 16px; font-weight: bold;">${servicesUp}/${totalServices} services operational</span>
                        <div style="flex-grow: 1; height: 10px; background-color: #444; border-radius: 5px; overflow: hidden;">
                            <div style="width: ${(servicesUp/totalServices*100)}%; height: 100%; background-color: ${servicesUp === totalServices ? 'var(--success-color)' : 'var(--warning-color)'}"></div>
                        </div>
                        <button id="view-health-details" style="padding: 5px 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
                    </div>
                `;
                
                // Add click handler for the details button
                document.getElementById('view-health-details').addEventListener('click', function() {
                    // Trigger click on the health menu item
                    document.getElementById('health-link').click();
                });
            })
            .catch(error => {
                console.error('Error checking health status:', error);
                servicesHealth.innerHTML = `
                    <div style="color: var(--danger-color);">
                        <i class="fas fa-exclamation-triangle"></i> Error checking service health
                        <button id="retry-health-check" style="margin-left: 10px; padding: 5px 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
                    </div>
                `;
                
                document.getElementById('retry-health-check').addEventListener('click', fetchHealthStatus);
            });
        }
        
        // Function to fetch detailed health status for the health page
        function fetchDetailedHealthStatus() {
            const services = [
                { name: 'Movie Service', url: 'http://localhost:3002/health', endpoint: 'http://localhost:3002/movies' },
                { name: 'Theater Service', url: 'http://localhost:3003/health', endpoint: 'http://localhost:3003/theaters' },
                { name: 'Schedule Service', url: 'http://localhost:3000/health', endpoint: 'http://localhost:3000/schedules' },
                { name: 'User Service', url: 'http://localhost:3001/health', endpoint: 'http://localhost:3001/users' },
                { name: 'Booking Service', url: 'http://localhost:3004/health', endpoint: 'http://localhost:3004/booking' },
                { name: 'Recommendation Service', url: 'http://localhost:3007/health', endpoint: 'http://localhost:3007/recommendations' },
                { name: 'Payment Service', url: 'http://localhost:3005/health', endpoint: 'http://localhost:3005/payments' },
                { name: 'Notification Service', url: 'http://localhost:3006/health', endpoint: 'http://localhost:3006/notifications' }
            ];
            
            const servicesHealthDetail = document.getElementById('services-health-detail');
            servicesHealthDetail.innerHTML = '<p>Checking service health...</p>';
            
            // Create a table to display service status
            const servicesTable = document.createElement('table');
            servicesTable.style.width = '100%';
            servicesTable.style.borderCollapse = 'collapse';
            
            // Add table header
            const header = document.createElement('tr');
            
            const serviceNameHeader = document.createElement('th');
            serviceNameHeader.textContent = 'Service';
            serviceNameHeader.style.textAlign = 'left';
            serviceNameHeader.style.padding = '12px';
            serviceNameHeader.style.borderBottom = '1px solid #444';
            
            const statusHeader = document.createElement('th');
            statusHeader.textContent = 'Status';
            statusHeader.style.textAlign = 'left';
            statusHeader.style.padding = '12px';
            statusHeader.style.borderBottom = '1px solid #444';
            
            const endpointHeader = document.createElement('th');
            endpointHeader.textContent = 'Endpoint';
            endpointHeader.style.textAlign = 'left';
            endpointHeader.style.padding = '12px';
            endpointHeader.style.borderBottom = '1px solid #444';
            
            const actionsHeader = document.createElement('th');
            actionsHeader.textContent = 'Actions';
            actionsHeader.style.textAlign = 'left';
            actionsHeader.style.padding = '12px';
            actionsHeader.style.borderBottom = '1px solid #444';
            
            header.appendChild(serviceNameHeader);
            header.appendChild(statusHeader);
            header.appendChild(endpointHeader);
            header.appendChild(actionsHeader);
            servicesTable.appendChild(header);
            
            // Check each service with timeout
            let allServicesUp = true;
            
            Promise.all(
                services.map(service => {
                    return fetch(service.url, { 
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors',
                        signal: AbortSignal.timeout(2000)
                    })
                    .then(response => {
                        if (response.ok) {
                            return { ...service, status: 'UP' };
                        } else {
                            return { ...service, status: 'DOWN' };
                        }
                    })
                    .catch(() => {
                        return { ...service, status: 'DOWN' };
                    });
                })
            )
            .then(results => {
                results.forEach(result => {
                    if (result.status !== 'UP') allServicesUp = false;
                    
                    const row = document.createElement('tr');
                    
                    const serviceName = document.createElement('td');
                    serviceName.textContent = result.name;
                    serviceName.style.padding = '12px';
                    serviceName.style.borderBottom = '1px solid #333';
                    
                    const serviceStatus = document.createElement('td');
                    const statusSpan = document.createElement('span');
                    statusSpan.textContent = result.status;
                    statusSpan.style.padding = '5px 10px';
                    statusSpan.style.borderRadius = '4px';
                    statusSpan.style.fontSize = '14px';
                    statusSpan.style.fontWeight = 'bold';
                    
                    if (result.status === 'UP') {
                        statusSpan.style.backgroundColor = 'var(--success-color)';
                    } else {
                        statusSpan.style.backgroundColor = 'var(--danger-color)';
                    }
                    
                    serviceStatus.appendChild(statusSpan);
                    serviceStatus.style.padding = '12px';
                    serviceStatus.style.borderBottom = '1px solid #333';
                    
                    const serviceEndpoint = document.createElement('td');
                    serviceEndpoint.textContent = result.endpoint;
                    serviceEndpoint.style.padding = '12px';
                    serviceEndpoint.style.borderBottom = '1px solid #333';
                    serviceEndpoint.style.fontFamily = 'monospace';
                    
                    const serviceActions = document.createElement('td');
                    serviceActions.style.padding = '12px';
                    serviceActions.style.borderBottom = '1px solid #333';
                    
                    const viewButton = document.createElement('button');
                    viewButton.textContent = 'View';
                    viewButton.style.padding = '5px 10px';
                    viewButton.style.backgroundColor = 'var(--info-color)';
                    viewButton.style.color = 'white';
                    viewButton.style.border = 'none';
                    viewButton.style.borderRadius = '4px';
                    viewButton.style.cursor = 'pointer';
                    viewButton.style.marginRight = '5px';
                    viewButton.addEventListener('click', () => {
                        window.open(result.endpoint, '_blank');
                    });
                    
                    serviceActions.appendChild(viewButton);
                    
                    row.appendChild(serviceName);
                    row.appendChild(serviceStatus);
                    row.appendChild(serviceEndpoint);
                    row.appendChild(serviceActions);
                    servicesTable.appendChild(row);
                });
                
                servicesHealthDetail.innerHTML = '';
                
                const status = document.createElement('div');
                status.style.marginBottom = '20px';
                status.style.fontSize = '18px';
                status.style.fontWeight = 'bold';
                status.textContent = `Overall System Status: ${allServicesUp ? 'All Services Operational' : 'Partial System Degradation'}`;
                status.style.color = allServicesUp ? 'var(--success-color)' : 'var(--warning-color)';
                
                const statusDescription = document.createElement('p');
                statusDescription.style.marginBottom = '20px';
                statusDescription.style.color = '#aaa';
                if (allServicesUp) {
                    statusDescription.textContent = 'All microservices are running correctly.';
                } else {
                    const servicesDown = results.filter(result => result.status === 'DOWN').length;
                    statusDescription.textContent = `${servicesDown} out of ${services.length} microservices are currently unavailable. This may affect some system functionality.`;
                }
                
                servicesHealthDetail.appendChild(status);
                servicesHealthDetail.appendChild(statusDescription);
                servicesHealthDetail.appendChild(servicesTable);
                
                // Add a refresh button
                const refreshButton = document.createElement('button');
                refreshButton.textContent = 'Refresh Status';
                refreshButton.style.marginTop = '20px';
                refreshButton.style.padding = '10px 20px';
                refreshButton.style.backgroundColor = 'var(--primary-color)';
                refreshButton.style.color = 'white';
                refreshButton.style.border = 'none';
                refreshButton.style.borderRadius = '4px';
                refreshButton.style.cursor = 'pointer';
                refreshButton.addEventListener('click', fetchDetailedHealthStatus);
                
                servicesHealthDetail.appendChild(refreshButton);
            })
            .catch(error => {
                console.error('Error checking detailed health status:', error);
                servicesHealthDetail.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; color: var(--danger-color);"></i>
                        <h2 style="margin-top: 15px; color: var(--danger-color);">Error Checking Services</h2>
                        <p style="margin: 15px 0; color: #aaa;">Unable to fetch service health information. This might indicate network issues or that the main application is unable to communicate with the microservices.</p>
                        <button id="retry-detailed-health" style="padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
                    </div>
                `;
                
                document.getElementById('retry-detailed-health').addEventListener('click', fetchDetailedHealthStatus);
            });
        }
    </script>
</body>
</html>